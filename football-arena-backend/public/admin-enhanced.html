<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Arena - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0A0E27 0%, #1A1F3A 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: #1A1F3A;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #B0B8C1;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #2A2F4A;
            border-radius: 8px;
            background: #0A0E27;
            color: #fff;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #0A0E27;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        /* Dashboard (hidden until login) */
        #dashboardScreen {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 900;
            color: #0A0E27;
        }

        .header button {
            background: #0A0E27;
            color: #FFD700;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1A1F3A;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #B0B8C1;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .stat-card .value {
            font-size: 42px;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #1A1F3A;
            border: none;
            color: #B0B8C1;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #0A0E27;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: #1A1F3A;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2A2F4A;
        }

        th {
            background: #0A0E27;
            color: #FFD700;
            font-weight: 600;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-easy { background: #4CAF50; color: white; }
        .badge-medium { background: #FF9800; color: white; }
        .badge-hard { background: #F44336; color: white; }
        .badge-vip { background: #FFD700; color: #0A0E27; }
        .badge-guest { background: #9E9E9E; color: white; }

        .btn-danger {
            background: #F44336;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            margin-right: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #1A1F3A;
            padding: 30px;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 32px;
            cursor: pointer;
        }

        textarea, input[type="text"], input[type="date"], input[type="time"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #2A2F4A;
            border-radius: 8px;
            background: #0A0E27;
            color: #fff;
            font-size: 14px;
            margin-top: 8px;
        }

        .file-upload {
            border: 2px dashed #2A2F4A;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin-top: 8px;
        }

        .file-upload:hover {
            border-color: #FFD700;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #B0B8C1;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background: #0A0E27;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2A2F4A;
        }

        .scheduler-item {
            background: #0A0E27;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #2A2F4A;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <h1>üîê Admin Login</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="adminEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <p style="margin-top: 20px; text-align: center; color: #B0B8C1; font-size: 12px;">
                Note: You must have admin privileges to access this panel.
            </p>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="container">
        <div class="header">
            <div>
                <h1>‚öΩ Football Arena Admin</h1>
                <p style="color: #0A0E27; margin-top: 8px;">Manage users, questions, and content</p>
            </div>
            <button onclick="logout()">Logout</button>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Registered Users</h3>
                <div class="value" id="registeredUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Questions</h3>
                <div class="value" id="totalQuestions">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Questions</h3>
                <div class="value" id="activeQuestions">-</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">üë• Users</button>
            <button class="tab" onclick="switchTab('questions')">‚ùì Questions</button>
            <button class="tab" onclick="switchTab('scheduler')">üìÖ Daily Quiz Scheduler</button>
            <button class="tab" onclick="switchTab('analytics')">üìä Content Analytics</button>
        </div>

        <!-- Users Section -->
        <div class="content-section active" id="users-section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Users Management</h2>
                <div id="usersTable" class="loading">Loading users...</div>
            </div>
        </div>

        <!-- Questions Section -->
        <div class="content-section" id="questions-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Questions Management</h2>
                    <button class="btn btn-primary" onclick="openAddQuestionModal()">
                        ‚ûï Add New Question
                    </button>
                </div>
                <div id="questionsTable" class="loading">Loading questions...</div>
            </div>
        </div>

        <!-- Scheduler Section -->
        <div class="content-section" id="scheduler-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Daily Quiz Scheduler</h2>
                    <button class="btn btn-primary" onclick="openScheduleModal()">
                        ‚ûï Schedule Quiz
                    </button>
                </div>
                <div id="schedulesList" class="loading">Loading schedules...</div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="content-section" id="analytics-section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Content Analytics</h2>
                <div id="analyticsContent" class="loading">Loading analytics...</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div class="modal" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="questionModalTitle">Add New Question</h2>
                <button class="close-btn" onclick="closeQuestionModal()">&times;</button>
            </div>
            <form id="questionForm">
                <input type="hidden" id="questionId">
                
                <div class="form-group">
                    <label>Question Type *</label>
                    <select id="questionType" required onchange="updateQuestionForm()">
                        <option value="multipleChoice">Multiple Choice</option>
                        <option value="trueFalse">True/False</option>
                        <option value="imageBased">Image-based</option>
                        <option value="mediaBased">Media-based (Video)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Question Text (English) *</label>
                    <textarea id="questionText" required rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Question Text (Arabic)</label>
                    <textarea id="questionTextAr" rows="3"></textarea>
                </div>

                <div class="form-group" id="imageUploadGroup" style="display: none;">
                    <label>Question Image</label>
                    <div class="file-upload" onclick="document.getElementById('imageFile').click()">
                        <p>üì∑ Click to upload image</p>
                        <input type="file" id="imageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <div id="imagePreview"></div>
                    </div>
                    <input type="text" id="imageUrl" placeholder="Or enter image URL">
                </div>

                <div class="form-group" id="videoUploadGroup" style="display: none;">
                    <label>Question Video</label>
                    <div class="file-upload" onclick="document.getElementById('videoFile').click()">
                        <p>üé• Click to upload video</p>
                        <input type="file" id="videoFile" accept="video/*" style="display: none;" onchange="handleVideoUpload(event)">
                        <div id="videoPreview"></div>
                    </div>
                    <input type="text" id="videoUrl" placeholder="Or enter video URL">
                </div>

                <div class="form-group">
                    <label>Difficulty *</label>
                    <select id="difficulty" required>
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Categories (comma separated)</label>
                    <input type="text" id="categories" placeholder="e.g., World Cup, Players">
                </div>

                <div class="form-group" id="optionsGroup">
                    <label>Options *</label>
                    <div id="optionsContainer">
                        <div class="option-group" style="margin-bottom: 8px;">
                            <input type="text" class="option-input" placeholder="Option A" required>
                        </div>
                        <div class="option-group" style="margin-bottom: 8px;">
                            <input type="text" class="option-input" placeholder="Option B" required>
                        </div>
                        <div class="option-group" style="margin-bottom: 8px;">
                            <input type="text" class="option-input" placeholder="Option C" required>
                        </div>
                        <div class="option-group" style="margin-bottom: 8px;">
                            <input type="text" class="option-input" placeholder="Option D" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Correct Answer *</label>
                    <input type="text" id="correctAnswer" placeholder="Exact match with one option above" required>
                </div>

                <div class="form-group">
                    <label>Explanation</label>
                    <textarea id="explanation" rows="2" placeholder="Optional explanation for the answer"></textarea>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-danger" onclick="closeQuestionModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Save Question</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Schedule Daily Quiz</h2>
                <button class="close-btn" onclick="closeScheduleModal()">&times;</button>
            </div>
            <form id="scheduleForm">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="scheduleDate" required>
                </div>
                <div class="form-group">
                    <label>Time (optional)</label>
                    <input type="time" id="scheduleTime">
                </div>
                <div class="form-group">
                    <label>Number of Questions</label>
                    <input type="number" id="scheduleQuestionCount" value="15" min="10" max="20">
                </div>
                <div class="form-group">
                    <label>Category Filters (comma separated, optional)</label>
                    <input type="text" id="scheduleCategories" placeholder="World Cup, Players">
                </div>
                <div class="form-group">
                    <label>Difficulty Filters (comma separated, optional)</label>
                    <input type="text" id="scheduleDifficulties" placeholder="easy, medium">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="scheduleNotes" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-danger" onclick="closeScheduleModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Create Schedule</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let adminToken = localStorage.getItem('adminToken');
        let currentTab = 'users';
        let editingQuestionId = null;

        // Check if already logged in
        if (adminToken) {
            showDashboard();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const res = await fetch(`${API_URL}/admin/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                if (res.ok) {
                    const data = await res.json();
                    adminToken = data.access_token;
                    localStorage.setItem('adminToken', adminToken);
                    showDashboard();
                } else {
                    const error = await res.json();
                    alert('Login failed: ' + (error.message || 'Invalid credentials'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            loadStats();
            loadUsers();
        }

        function logout() {
            adminToken = null;
            localStorage.removeItem('adminToken');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
        }

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`,
            };
        }

        // Switch Tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-section`).classList.add('active');

            if (tab === 'users') loadUsers();
            if (tab === 'questions') loadQuestions();
            if (tab === 'scheduler') loadSchedules();
            if (tab === 'analytics') loadAnalytics();
        }

        // Load Dashboard Stats
        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/admin/stats/dashboard`, {
                    headers: getAuthHeaders(),
                });
                const data = await res.json();
                
                document.getElementById('totalUsers').textContent = data.users.total;
                document.getElementById('registeredUsers').textContent = data.users.registered;
                document.getElementById('totalQuestions').textContent = data.questions.total;
                document.getElementById('activeQuestions').textContent = data.questions.active;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Users
        async function loadUsers() {
            document.getElementById('usersTable').innerHTML = '<div class="loading">Loading users...</div>';
            
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: getAuthHeaders(),
                });
                const data = await res.json();
                
                let html = '<table><thead><tr>';
                html += '<th>Username</th><th>Email</th><th>Country</th><th>Level</th><th>XP</th><th>Coins</th><th>Games</th><th>Type</th><th>Actions</th>';
                html += '</tr></thead><tbody>';

                data.data.forEach(user => {
                    html += '<tr>';
                    html += `<td><strong>${user.username}</strong></td>`;
                    html += `<td>${user.email}</td>`;
                    html += `<td>${user.country}</td>`;
                    html += `<td>${user.level}</td>`;
                    html += `<td>${user.xp}</td>`;
                    html += `<td>${user.coins}</td>`;
                    html += `<td>${user.totalGames}</td>`;
                    html += `<td>${user.isVip ? '<span class="badge badge-vip">VIP</span>' : user.isGuest ? '<span class="badge badge-guest">Guest</span>' : 'Regular'}</td>`;
                    html += `<td><button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = html;
            } catch (error) {
                document.getElementById('usersTable').innerHTML = '<div class="loading">Error loading users. Make sure you are logged in.</div>';
            }
        }

        // Load Questions
        async function loadQuestions() {
            document.getElementById('questionsTable').innerHTML = '<div class="loading">Loading questions...</div>';
            
            try {
                const res = await fetch(`${API_URL}/admin/questions?limit=100`, {
                    headers: getAuthHeaders(),
                });
                const data = await res.json();
                
                let html = '<table><thead><tr>';
                html += '<th>Question</th><th>Type</th><th>Difficulty</th><th>Categories</th><th>Correct Answer</th><th>Active</th><th>Actions</th>';
                html += '</tr></thead><tbody>';

                data.data.forEach(q => {
                    html += '<tr>';
                    html += `<td style="max-width: 400px;">${q.text.substring(0, 80)}${q.text.length > 80 ? '...' : ''}</td>`;
                    html += `<td><span class="badge">${q.type || 'multipleChoice'}</span></td>`;
                    html += `<td><span class="badge badge-${q.difficulty}">${q.difficulty.toUpperCase()}</span></td>`;
                    html += `<td>${q.categories?.join(', ') || 'General'}</td>`;
                    html += `<td><strong>${q.correctAnswer}</strong></td>`;
                    html += `<td>${q.isActive ? '‚úÖ' : '‚ùå'}</td>`;
                    html += `<td>
                        <button class="btn btn-edit" onclick="editQuestion('${q.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteQuestion('${q.id}')">Delete</button>
                    </td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                document.getElementById('questionsTable').innerHTML = html;
            } catch (error) {
                document.getElementById('questionsTable').innerHTML = '<div class="loading">Error loading questions.</div>';
            }
        }

        // Edit Question
        async function editQuestion(id) {
            editingQuestionId = id;
            try {
                const res = await fetch(`${API_URL}/admin/questions/${id}`, {
                    headers: getAuthHeaders(),
                });
                const question = await res.json();

                document.getElementById('questionModalTitle').textContent = 'Edit Question';
                document.getElementById('questionId').value = question.id;
                document.getElementById('questionType').value = question.type || 'multipleChoice';
                document.getElementById('questionText').value = question.text;
                document.getElementById('questionTextAr').value = question.textAr || '';
                document.getElementById('difficulty').value = question.difficulty;
                document.getElementById('categories').value = question.categories?.join(', ') || '';
                document.getElementById('correctAnswer').value = question.correctAnswer;
                document.getElementById('explanation').value = question.explanation || '';
                document.getElementById('imageUrl').value = question.imageUrl || '';
                document.getElementById('videoUrl').value = question.videoUrl || '';

                // Update options
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                question.options.forEach((opt, idx) => {
                    const div = document.createElement('div');
                    div.className = 'option-group';
                    div.style.marginBottom = '8px';
                    div.innerHTML = `<input type="text" class="option-input" placeholder="Option ${String.fromCharCode(65 + idx)}" value="${opt}" required>`;
                    optionsContainer.appendChild(div);
                });

                updateQuestionForm();
                document.getElementById('questionModal').classList.add('active');
            } catch (error) {
                alert('Error loading question: ' + error.message);
            }
        }

        // Update Question Form based on type
        function updateQuestionForm() {
            const type = document.getElementById('questionType').value;
            const optionsGroup = document.getElementById('optionsGroup');
            const imageGroup = document.getElementById('imageUploadGroup');
            const videoGroup = document.getElementById('videoUploadGroup');
            const optionsContainer = document.getElementById('optionsContainer');

            // Reset visibility
            imageGroup.style.display = 'none';
            videoGroup.style.display = 'none';

            if (type === 'trueFalse') {
                optionsGroup.style.display = 'none';
                document.getElementById('correctAnswer').placeholder = 'Enter "True" or "False"';
            } else if (type === 'imageBased') {
                optionsGroup.style.display = 'block';
                imageGroup.style.display = 'block';
                document.getElementById('correctAnswer').placeholder = 'Exact match with one option';
            } else if (type === 'mediaBased') {
                optionsGroup.style.display = 'block';
                videoGroup.style.display = 'block';
                document.getElementById('correctAnswer').placeholder = 'Exact match with one option';
            } else {
                optionsGroup.style.display = 'block';
                document.getElementById('correctAnswer').placeholder = 'Exact match with one option';
            }
        }

        // File Upload Handlers
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Convert to base64 (in production, upload to storage service)
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                try {
                    const res = await fetch(`${API_URL}/admin/upload/image`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            base64: base64,
                            filename: file.name,
                        }),
                    });
                    const data = await res.json();
                    document.getElementById('imageUrl').value = data.url;
                    document.getElementById('imagePreview').innerHTML = `<img src="${data.url}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">`;
                } catch (error) {
                    alert('Upload failed: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        async function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                try {
                    const res = await fetch(`${API_URL}/admin/upload/video`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            base64: base64,
                            filename: file.name,
                        }),
                    });
                    const data = await res.json();
                    document.getElementById('videoUrl').value = data.url;
                    document.getElementById('videoPreview').innerHTML = `<p style="color: #4CAF50; margin-top: 10px;">‚úÖ Video uploaded: ${file.name}</p>`;
                } catch (error) {
                    alert('Upload failed: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        // Question Form Submit
        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const options = Array.from(document.querySelectorAll('.option-input'))
                .map(input => input.value.trim())
                .filter(val => val !== '');

            const categories = document.getElementById('categories').value
                .split(',')
                .map(c => c.trim())
                .filter(c => c !== '');

            const questionData = {
                text: document.getElementById('questionText').value,
                textAr: document.getElementById('questionTextAr').value || null,
                type: document.getElementById('questionType').value,
                difficulty: document.getElementById('difficulty').value,
                categories: categories.length > 0 ? categories : ['General'],
                options: document.getElementById('questionType').value === 'trueFalse' 
                    ? ['True', 'False'] 
                    : options,
                correctAnswer: document.getElementById('correctAnswer').value,
                explanation: document.getElementById('explanation').value || null,
                imageUrl: document.getElementById('imageUrl').value || null,
                videoUrl: document.getElementById('videoUrl').value || null,
                isActive: true,
            };

            try {
                const questionId = document.getElementById('questionId').value;
                const url = questionId 
                    ? `${API_URL}/admin/questions/${questionId}`
                    : `${API_URL}/admin/questions`;
                const method = questionId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(questionData),
                });

                if (res.ok) {
                    alert(questionId ? 'Question updated successfully!' : 'Question created successfully!');
                    closeQuestionModal();
                    loadQuestions();
                    loadStats();
                } else {
                    const error = await res.json();
                    alert('Error: ' + (error.message || 'Failed to save question'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Schedule Functions
        function openScheduleModal() {
            document.getElementById('scheduleModal').classList.add('active');
            document.getElementById('scheduleDate').valueAsDate = new Date();
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            document.getElementById('scheduleForm').reset();
        }

        async function loadSchedules() {
            document.getElementById('schedulesList').innerHTML = '<div class="loading">Loading schedules...</div>';
            try {
                const res = await fetch(`${API_URL}/admin/scheduler/daily-quiz`, {
                    headers: getAuthHeaders(),
                });
                const data = await res.json();
                
                if (data.schedules && data.schedules.length > 0) {
                    let html = '';
                    data.schedules.forEach(schedule => {
                        html += `<div class="scheduler-item">
                            <div>
                                <strong>${new Date(schedule.scheduledDate).toLocaleDateString()}</strong>
                                ${schedule.scheduledTime ? ` at ${schedule.scheduledTime}` : ''}
                                <br>
                                <small>${schedule.questionCount} questions</small>
                            </div>
                            <div>
                                <button class="btn btn-edit" onclick="editSchedule('${schedule.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteSchedule('${schedule.id}')">Delete</button>
                            </div>
                        </div>`;
                    });
                    document.getElementById('schedulesList').innerHTML = html;
                } else {
                    document.getElementById('schedulesList').innerHTML = '<p style="text-align: center; color: #B0B8C1;">No schedules found. Create one to get started!</p>';
                }
            } catch (error) {
                document.getElementById('schedulesList').innerHTML = '<div class="loading">Error loading schedules.</div>';
            }
        }

        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const scheduleData = {
                scheduledDate: document.getElementById('scheduleDate').value,
                scheduledTime: document.getElementById('scheduleTime').value || null,
                questionCount: parseInt(document.getElementById('scheduleQuestionCount').value),
                categoryFilters: document.getElementById('scheduleCategories').value
                    .split(',')
                    .map(c => c.trim())
                    .filter(c => c !== ''),
                difficultyFilters: document.getElementById('scheduleDifficulties').value
                    .split(',')
                    .map(d => d.trim())
                    .filter(d => d !== ''),
                notes: document.getElementById('scheduleNotes').value || null,
                isActive: true,
            };

            try {
                const res = await fetch(`${API_URL}/admin/scheduler/daily-quiz`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(scheduleData),
                });

                if (res.ok) {
                    alert('Schedule created successfully!');
                    closeScheduleModal();
                    loadSchedules();
                } else {
                    const error = await res.json();
                    alert('Error: ' + (error.message || 'Failed to create schedule'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Analytics
        async function loadAnalytics() {
            document.getElementById('analyticsContent').innerHTML = '<div class="loading">Loading analytics...</div>';
            try {
                const res = await fetch(`${API_URL}/admin/analytics/content`, {
                    headers: getAuthHeaders(),
                });
                const data = await res.json();
                
                let html = '<div class="analytics-grid">';
                
                // Question Type Distribution
                html += `<div class="analytics-card">
                    <h3>Question Types</h3>
                    <p>Multiple Choice: ${data.questions.byType.multipleChoice}</p>
                    <p>True/False: ${data.questions.byType.trueFalse}</p>
                    <p>Image-based: ${data.questions.byType.imageBased}</p>
                    <p>Media-based: ${data.questions.byType.mediaBased || 0}</p>
                </div>`;

                // Difficulty Distribution
                html += `<div class="analytics-card">
                    <h3>Difficulty Distribution</h3>
                    <p>Easy: ${data.questions.byDifficulty.easy}</p>
                    <p>Medium: ${data.questions.byDifficulty.medium}</p>
                    <p>Hard: ${data.questions.byDifficulty.hard}</p>
                </div>`;

                // Daily Quiz Stats
                html += `<div class="analytics-card">
                    <h3>Daily Quiz Performance</h3>
                    <p>Total Attempts: ${data.dailyQuiz.totalAttempts}</p>
                    <p>Average Score: ${data.dailyQuiz.averageScore.toFixed(1)}</p>
                    <p>Average Accuracy: ${data.dailyQuiz.averageAccuracy.toFixed(1)}%</p>
                    <p>Perfect Scores: ${data.dailyQuiz.perfectScores}</p>
                </div>`;

                html += '</div>';
                document.getElementById('analyticsContent').innerHTML = html;
            } catch (error) {
                document.getElementById('analyticsContent').innerHTML = '<div class="loading">Error loading analytics.</div>';
            }
        }

        // Delete Functions
        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                });
                if (res.ok) {
                    alert('User deleted successfully!');
                    loadUsers();
                    loadStats();
                } else {
                    alert('Error deleting user');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('Are you sure you want to delete this question?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/questions/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                });
                if (res.ok) {
                    alert('Question deleted successfully!');
                    loadQuestions();
                    loadStats();
                } else {
                    alert('Error deleting question');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Modal Functions
        function openAddQuestionModal() {
            editingQuestionId = null;
            document.getElementById('questionModalTitle').textContent = 'Add New Question';
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            updateQuestionForm();
            document.getElementById('questionModal').classList.add('active');
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.remove('active');
            document.getElementById('questionForm').reset();
            editingQuestionId = null;
        }
    </script>
</body>
</html>

